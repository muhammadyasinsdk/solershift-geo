<!doctype html>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Geo Helper</title>
<style>
  body{margin:0;font:14px system-ui,Segoe UI,Roboto,Arial;background:#0b1220;color:#e6eef7;
       display:grid;place-items:center;height:100vh}
  .card{background:#0e1728;border:1px solid #1b2a44;border-radius:12px;padding:16px;max-width:360px}
  button{padding:10px 14px;border-radius:10px;border:0;background:#38bdf8;color:#03121f;
         font-weight:600;cursor:pointer}
  .small{color:#98a7bd;font-size:12px;margin-top:8px}
</style>

<div class="card">
  <h3 style="margin:0 0 8px">Get Location</h3>
  <p class="small">This secure helper will send your GPS coordinates to the parent page.</p>
  <button id="btn">Allow Location</button>
  <div id="msg" class="small"></div>
</div>

<script>
/* ---------- Trusted parent origin resolve (ESP page) ---------- */
/* ترجیح: ?parent=... > document.referrer > fallback (192.168.4.1) */
const DEFAULT_PARENT = 'http://192.168.4.1';
const PARENT_ORIGIN = (() => {
  try {
    const qs = new URLSearchParams(location.search);
    const parentParam = qs.get('parent');
    if (parentParam) return new URL(parentParam).origin;
    if (document.referrer) return new URL(document.referrer).origin;
  } catch(_) {}
  return DEFAULT_PARENT;
})();

/* صرف trusted parent کو ہی postMessage کریں */
const send = (obj) => parent.postMessage(Object.assign({ type:'geo' }, obj), PARENT_ORIGIN);

function doGeo(){
  const m = document.getElementById('msg');
  if (!('geolocation' in navigator)){
    send({err:'no_geolocation'});
    m.textContent = 'Geolocation not supported.';
    return;
  }
  m.textContent = 'Requesting location…';
  navigator.geolocation.getCurrentPosition(
    p => {
      const { latitude, longitude, accuracy } = p.coords;
      send({ lat: latitude, lon: longitude, acc: accuracy });
      m.textContent = `Lat ${latitude.toFixed(5)}, Lon ${longitude.toFixed(5)} (±${Math.round(accuracy)}m)`;
    },
    e => {
      send({ err: e.message || 'denied' });
      m.textContent = 'Error: ' + (e.message || 'denied');
    },
    { enableHighAccuracy: true, timeout: 8000, maximumAge: 60000 }
  );
}

/* 1) بٹن (user gesture) */
document.getElementById('btn').addEventListener('click', doGeo);

/* 2) آٹو موڈ: ?auto=1 یا #auto پر خود بخود چلائیں */
const q = new URLSearchParams(location.search);
if (q.get('auto') === '1' || location.hash.includes('auto')) {
  setTimeout(doGeo, 100); // تھوڑا defer تاکہ parent attach ہو جائے
}

/* 3) اگر والد صفحہ postMessage سے "go" بھیجے — مگر trusted origin پر */
window.addEventListener('message', (e) => {
  const d = e.data || {};
  if (e.origin === PARENT_ORIGIN && d && d.type === 'go') {
    doGeo();
  }
});
</script>
